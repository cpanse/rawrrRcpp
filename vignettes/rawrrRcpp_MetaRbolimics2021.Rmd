---
title: "rawrrRcpp"
subtitle: "Access to Orbitrap Data and Beyond"
author: "Christian Panse <cp@fgz.ethz.ch>"
date: "MetaRbolomics 2021, Leucorea Lutherstadt Wittenberg"
output:
  ioslides_presentation:
    widescreen: yes
    smaller: yes
  beamer_presentation: default
---

<style>
.forceBreak { -webkit-column-break-after: always; break-after: column; }
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,  eval=TRUE, message=FALSE, warning=FALSE)
options(prompt = "R> ")
```

## Past and present

<div class='note'>

* The Functional Genomics Center Zurich - https://fgcz.ch/ 
* joint state-of-the-art research and training (core) facility of ETH Zurich and University of Zurich.
* offer/support analytical services, training, collaborative R&D in:
* `Genomics |  Metabolomics | Proteomics`
* Proteomics currently processes output of ~12 MS (mostly LC-ESI-MS). Many Orbitraps, fewer TOFs. 

</div>



`rawDiag | rawrr | MsBackendRawFileReader`

<div class="columns-2">

interfacing ThermoFisher libraries via:

1. `system2` call
	+ `mono rawrr.exe argv > out.R` 
	+ parse R code by calling `source('out.R')`
2. `rCLr` see https://github.com/rdotnet/rClr/blob/master/R/zzz.R

```{r arch2, echo=FALSE, out.width="90%", error=TRUE, fig.align='center'}
knitr::include_graphics("arch2.svg")
```
</div>



## Today - invoke managed methods from C++

<table>
<tr style="border:2px solid black">
<td style="padding:15px">
`R>`
</td>
</tr>

<tr style="border:2px solid black">
<td style="padding:15px">
`Rcpp module`
</td>
</tr>

<tr style="background-color:yellow;color:black; border:2px solid black">
<td style="padding:15px">
`C++ code`
</td>
</tr>

<tr style="background-color:yellowgreen;color:black; border:2px solid black">
<td style="padding:15px">
Mono Runtime - linking `libmono-2`
</td>
</tr>

<tr style="background-color:orange;color:black; border:2px solid black">
<td style="padding:15px">
Managed Assembly
(CIL/.NET code)
</td>
</tr>

<tr style="background-color:orange;color:black; border:2px solid black">
<td style="padding:15px">
ThermoFisher.CommonCore.*.dll
</td>
</tr>
</table>

<br>

* https://www.mono-project.com/docs/advanced/embedding/
* https://planetorbitrap.com/rawfilereader (dead link)



## Code snippet - reproduce scan 9594 EH4547

```{r eval=TRUE, echo=TRUE, fig.width=9, fig.height=3}
Sys.setenv("PKG_CXXFLAGS"="`pkg-config --cflags mono-2` -O3")
Sys.setenv("PKG_LIBS"="`pkg-config --libs mono-2`")
setwd('../src/'); Rcpp::sourceCpp("rawrrRcpp.cpp")
EH4547 <- "/home/cpanse/.cache/R/ExperimentHub/18e7d5bfb4a3b_4590.raw"
R <- new(Rawrr); R$setDomainName("rawrrRcpp"); R$createObject(); R$setRawFile(EH4547); R$openFile()
mZ <- R$get_values(9594, "CentroidScan.Masses")
intensity <- R$get_values(9594, "CentroidScan.Intensities")
plot(mZ, intensity , type='h')
```
https://bioconductor.org/packages/rawrr/ - [vignette Figure 1](https://bioconductor.org/packages/release/bioc/vignettes/rawrr/inst/doc/rawrr.html#31_Use_Case_I_-_Analyzing_Orbitrap_Spectra).

## Single core I/O performance using EH4547

```{r benchmark, fig.width=9, fig.height=5.5, fig.retina=3, echo=FALSE}
source('plotBenchmark.R')
```

## Conclusion, thoughts, and open issues

* Invoke managed methods (ThermoFisher.CommonCore.*.dll) from Rcpp/C++ using libmono-2
  * is faster 
  * solves language setting/digits setup issues, e.g., https://github.com/fgcz/rawDiag/issues/33
* How to handle the mono domain (namespace)? Shall we use one mono VM domain through the entire R session? 
* What about using dotnet? What is the future of mono?
* At the moment, it runs only for mono version 5.18. The current mono version is 6.12.
* Can we use static linked libraries, e.g., libmono-2.a? If yes, no mono install is required. 
* Source code snippets: https://gitlab.bfabric.org/proteomics/rawrrrcpp

## Thanks

* Tobias Kockmann
* Christian Trachsel
* Witold E. Wolski
* Hervé Pagès 

```{r ZH, echo=FALSE, out.width="100%", error=TRUE, fig.align='center'}
knitr::include_graphics("ZH.jpeg")
```

<div class='note'>
```{r prx, echo=FALSE, out.width="100%", error=TRUE, fig.align='center'}
knitr::include_graphics("20211026-prx-Ziegelhuette.jpg")
```
`staffproteomics@fgcz.ethz.ch`
</div>


# Appendix

***
```{r sessioninfo, echo=FALSE}
sessionInfo()
```
***
```{bash}
mono --version
```

***
```{r make, echo=FALSE, out.width="100%", error=TRUE, fig.align='center'}
knitr::include_graphics("rawrrRcpp-make.jpg")
```
